name: Integration Test [Memory]
description: Integration tests for memory features with Milvus storage backend
on:
  pull_request:
    branches:
      - main
    paths:
      - 'src/semantic-router/pkg/memory/**'
      - 'src/semantic-router/pkg/extproc/*memory*'
      - 'src/semantic-router/pkg/responseapi/**'
      - 'src/vllm-sr/**'
      - 'e2e/testing/09-memory-features-test.py'
      - 'config/testing/config.memory*.yaml'
      - '.github/workflows/integration-test-memory.yml'
  workflow_dispatch:

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  memory-integration-test:
    name: Memory Integration Test
    runs-on: ubuntu-latest
    timeout-minutes: 60

    steps:
      - name: Check out the repo
        uses: actions/checkout@v4

      # NOTE: Model storage setup skipped - using echo backend for memory tests

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.24'

      - name: Set up Rust
        uses: actions-rust-lang/setup-rust-toolchain@v1
        with:
          toolchain: "1.90"

      - name: Install Python dependencies
        run: pip install -U "huggingface_hub[cli]" hf_transfer requests pymilvus

      # Download BERT embedding model for memory (required even with echo backend)
      # Memory needs embeddings to store/retrieve from Milvus - can't skip this
      - name: Download BERT embedding model
        run: |
          mkdir -p models
          python -c "from huggingface_hub import snapshot_download; snapshot_download('sentence-transformers/all-MiniLM-L12-v2', local_dir='models/mom-embedding-light', local_dir_use_symlinks=False)"
          echo "✅ BERT model downloaded to models/mom-embedding-light"
        env:
          HF_HUB_ENABLE_HF_TRANSFER: "1"

      - name: Start Milvus
        run: |
          make start-milvus
          for i in {1..60}; do
            curl -s http://localhost:9091/healthz 2>/dev/null | grep -q "OK" && echo "✅ Milvus ready" && break
            sleep 2
          done

      - name: Build and start llm-katan (echo backend for memory tests)
        run: |
          make docker-build-llm-katan DOCKER_TAG=ci
          # Use echo backend for memory tests - returns full prompt for keyword verification
          # This allows tests to verify memory was injected by checking for keywords in response
          docker run -d --name llm-katan --network host \
            ghcr.io/vllm-project/semantic-router/llm-katan:ci \
            llm-katan --model dummy --host 0.0.0.0 --port 8000 --served-model-name qwen3 --backend echo
          
          for i in {1..30}; do
            curl -s http://localhost:8000/health 2>/dev/null | grep -q "ok\|healthy" && echo "✅ llm-katan (echo) ready" && break
            docker ps | grep -q llm-katan || { echo "❌ llm-katan died"; docker logs llm-katan; exit 1; }
            sleep 1
          done

      - name: Install vllm-sr CLI and setup config
        run: |
          pip install ./src/vllm-sr
          cp config/testing/config.memory-user.yaml config.yaml
          vllm-sr validate --config config.yaml || true

      # Free up disk space for large Docker build (CUDA + PyTorch dependencies)
      - name: Free disk space
        run: |
          echo "=== Disk space before cleanup ==="
          df -h /
          
          # Remove unnecessary tools and libraries
          sudo rm -rf /usr/share/dotnet
          sudo rm -rf /usr/local/lib/android
          sudo rm -rf /opt/ghc
          sudo rm -rf /opt/hostedtoolcache/CodeQL
          
          # Clean apt cache
          sudo apt-get clean
          
          # Clean Docker (unused images, containers, volumes)
          docker system prune -af --volumes || true
          
          echo "=== Disk space after cleanup ==="
          df -h /

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build vllm-sr Docker image
        uses: docker/build-push-action@v6
        with:
          context: .
          file: src/vllm-sr/Dockerfile
          tags: vllm-sr:ci
          load: true

      - name: Start vllm-sr serve
        run: |
          vllm-sr serve --config config.yaml --image vllm-sr:ci --image-pull-policy never &
          VLLM_SR_PID=$!
          
          for i in {1..180}; do
            HTTP_CODE=$(curl -s -o /dev/null -w "%{http_code}" http://localhost:8888/health 2>/dev/null || echo "000")
            [ "$HTTP_CODE" = "200" ] && echo "✅ vllm-sr ready" && break
            kill -0 $VLLM_SR_PID 2>/dev/null || { echo "❌ vllm-sr died"; vllm-sr logs router; exit 1; }
            sleep 2
          done
          
          # Final verification
          HTTP_CODE=$(curl -s -o /dev/null -w "%{http_code}" http://localhost:8888/health 2>/dev/null || echo "000")
          if [ "$HTTP_CODE" != "200" ]; then
            echo "❌ vllm-sr not ready"
            exit 1
          fi

      - name: Run memory integration tests
        run: |
          cd e2e/testing
          python 09-memory-features-test.py
        env:
          PYTHONUNBUFFERED: 1
          ROUTER_ENDPOINT: http://localhost:8888
          MILVUS_ADDRESS: localhost:19530
          MILVUS_COLLECTION: memory_test_ci

      - name: Collect logs
        if: always()
        run: |
          mkdir -p logs
          
          # Router logs (full)
          docker exec vllm-sr-container cat /var/log/supervisor/router.log 2>&1 > logs/router.log || true
          docker exec vllm-sr-container cat /var/log/supervisor/router-error.log 2>&1 > logs/router-error.log || true
          
          # llm-katan logs
          docker logs llm-katan 2>&1 > logs/llm-katan.log || true
          
          # Milvus logs
          docker logs milvus-semantic-cache 2>&1 > logs/milvus.log || true
          
          # Container status
          docker ps -a > logs/docker-status.txt || true

      - name: Upload logs as artifact
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: memory-test-logs
          path: logs/
          retention-days: 7

      - name: Clean up
        if: always()
        run: |
          vllm-sr stop || true
          docker stop llm-katan vllm-sr-container 2>/dev/null || true
          docker rm llm-katan vllm-sr-container 2>/dev/null || true
          make stop-milvus || true
